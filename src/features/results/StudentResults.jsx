import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent, CardFooter } from '../../components/ui/Card';
import { Button } from '../../components/ui/Button';
import { Badge } from '../../components/ui/Badge';
import { ChevronLeft, FileText, FileSpreadsheet, CheckCircle2, XCircle, Calendar, Clock } from 'lucide-react';
import { getResultsByUser, exportSingleResultToExcel } from '../../lib/resultsManager';
import { cn } from '../../lib/utils';

export function StudentResults({ userName, onBack }) {
    const [results, setResults] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedResult, setSelectedResult] = useState(null);

    useEffect(() => {
        const loadResults = async () => {
            setLoading(true);
            const data = await getResultsByUser(userName);
            setResults(data);
            setLoading(false);
        };
        loadResults();
    }, [userName]);

    const handleDownloadMarkdown = (result) => {
        let content = `# Exam Results Report\n\n`;
        content += `**Student:** ${result.userName || 'Anonymous'}\n`;
        content += `**Exam:** ${result.examYear} ${result.subject}\n`;
        content += `**Date:** ${new Date(result.timestamp).toLocaleString()}\n`;
        content += `**Score:** ${result.score} / ${result.totalQuestions} (${result.percentage}%)\n`;
        content += `**Status:** ${result.percentage >= 50 ? 'PASS' : 'FAIL'}\n\n`;

        if (result.details) {
            content += `## Question Breakdown\n\n`;
            content += `| # | Question | Your Answer | Correct Answer | Result |\n`;
            content += `|---|---|---|---|---|\n`;

            const maxQ = result.totalQuestions;
            for (let i = 0; i < maxQ; i++) {
                const detail = result.details[i];
                if (detail) {
                    const resultIcon = detail.isCorrect ? '✅' : '❌';
                    const safeText = detail.questionText ? detail.questionText.replace(/\|/g, '-') : '-';
                    const selectedText = detail.selectedText ? ` (${detail.selectedText})` : '';
                    const correctText = detail.correctText ? ` (${detail.correctText})` : '';

                    content += `| ${i + 1} | ${safeText} | **${detail.selected ? detail.selected.toUpperCase() : '-'}${selectedText}** | ${detail.correct ? detail.correct.toUpperCase() : '-'}${correctText} | ${resultIcon} |\n`;
                }
            }
        } else {
            content += `*Detailed breakdown not available for this record.*\n`;
        }

        content += `\n---\n*Generated by Exam Portal App*`;

        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `exam-result-${result.examYear}-${result.userName || 'student'}-${Date.now()}.md`;
        a.click();
        URL.revokeObjectURL(url);
    };

    if (selectedResult) {
        return (
            <div className="max-w-4xl mx-auto space-y-6">
                <div className="flex items-center justify-between">
                    <Button variant="ghost" onClick={() => setSelectedResult(null)}>
                        <ChevronLeft className="mr-2 h-4 w-4" /> Back to List
                    </Button>
                    <div className="flex gap-2">
                        <Button variant="outline" size="sm" onClick={() => handleDownloadMarkdown(selectedResult)}>
                            <FileText className="mr-2 h-4 w-4" /> Markdown
                        </Button>
                        <Button variant="outline" size="sm" onClick={() => exportSingleResultToExcel(selectedResult)}>
                            <FileSpreadsheet className="mr-2 h-4 w-4" /> Excel
                        </Button>
                    </div>
                </div>

                <Card className="border-t-4 border-t-indigo-500">
                    <CardHeader className="text-center">
                        <CardTitle className="text-2xl">
                            {selectedResult.examYear} {selectedResult.subject}
                        </CardTitle>
                        <p className="text-slate-400">
                            Taken on {new Date(selectedResult.timestamp).toLocaleString()}
                        </p>
                    </CardHeader>
                    <CardContent className="space-y-6">
                        <div className="text-center p-6 rounded-xl bg-slate-900/50 border border-slate-800">
                            <div className="text-5xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent mb-2">
                                {selectedResult.percentage}%
                            </div>
                            <div className="text-slate-300">
                                {selectedResult.score} out of {selectedResult.totalQuestions} correct
                            </div>
                        </div>

                        <div className="space-y-3">
                            <h3 className="text-lg font-semibold text-slate-200">Question Breakdown</h3>
                            {selectedResult.details ? (
                                Array.from({ length: selectedResult.totalQuestions }).map((_, index) => {
                                    const detail = selectedResult.details[index];
                                    if (!detail) return null;

                                    return (
                                        <div
                                            key={index}
                                            className={cn(
                                                "p-4 rounded-lg border flex items-start gap-3",
                                                detail.isCorrect
                                                    ? "bg-emerald-500/10 border-emerald-500/20"
                                                    : "bg-red-500/10 border-red-500/20"
                                            )}
                                        >
                                            {detail.isCorrect ? (
                                                <CheckCircle2 className="h-5 w-5 text-emerald-400 mt-0.5 flex-shrink-0" />
                                            ) : (
                                                <XCircle className="h-5 w-5 text-red-400 mt-0.5 flex-shrink-0" />
                                            )}
                                            <div className="flex-1">
                                                <p className="text-slate-200 font-medium mb-1">
                                                    Q{index + 1}: {detail.questionText || 'Question Text Unavailable'}
                                                </p>
                                                <div className="text-sm text-slate-400 space-y-1">
                                                    <div>
                                                        Your answer: <span className={detail.isCorrect ? "text-emerald-400 font-medium" : "text-red-400 font-medium"}>
                                                            {detail.selected ? detail.selected.toUpperCase() : '-'}
                                                        </span>
                                                        <span className="text-slate-500 ml-2">
                                                            {detail.selectedText}
                                                        </span>
                                                    </div>

                                                    {!detail.isCorrect && (
                                                        <div className="flex items-center gap-2">
                                                            <span>Correct Answer:</span>
                                                            <span className="text-emerald-400 font-medium">
                                                                {detail.correct ? detail.correct.toUpperCase() : '-'}
                                                            </span>
                                                            <span className="text-slate-500">
                                                                {detail.correctText}
                                                            </span>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            ) : (
                                <p className="text-slate-500 italic text-center py-4">Detailed breakdown not available for this record.</p>
                            )}
                        </div>
                    </CardContent>
                </Card>
            </div>
        );
    }

    return (
        <div className="max-w-4xl mx-auto space-y-6">
            <div className="flex items-center justify-between">
                <h2 className="text-2xl font-bold text-slate-200">My Exam History</h2>
                <Button variant="ghost" onClick={onBack}>
                    Back to Exams
                </Button>
            </div>

            {loading ? (
                <div className="text-center text-slate-400 py-12">Loading history...</div>
            ) : results.length === 0 ? (
                <Card>
                    <CardContent className="flex flex-col items-center justify-center py-12 text-center">
                        <div className="h-16 w-16 rounded-full bg-slate-800 flex items-center justify-center mb-4">
                            <Clock className="h-8 w-8 text-slate-500" />
                        </div>
                        <h3 className="text-lg font-medium text-slate-300 mb-2">No Exams Taken Yet</h3>
                        <p className="text-slate-500 max-w-sm">
                            When you complete an exam, your results will appear here.
                        </p>
                    </CardContent>
                </Card>
            ) : (
                <div className="grid gap-4">
                    {results.map((result) => (
                        <Card
                            key={result.id}
                            className="hover:border-indigo-500/50 transition-colors cursor-pointer"
                            onClick={() => setSelectedResult(result)}
                        >
                            <CardContent className="p-6 flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className={cn(
                                        "h-12 w-12 rounded-full flex items-center justify-center font-bold text-lg",
                                        result.percentage >= 70 ? "bg-emerald-500/10 text-emerald-400" :
                                            result.percentage >= 50 ? "bg-amber-500/10 text-amber-400" :
                                                "bg-red-500/10 text-red-400"
                                    )}>
                                        {Math.round(result.percentage)}%
                                    </div>
                                    <div>
                                        <h3 className="font-semibold text-slate-200">
                                            {result.examYear} {result.subject}
                                        </h3>
                                        <div className="flex items-center gap-4 text-sm text-slate-400 mt-1">
                                            <span className="flex items-center gap-1">
                                                <Calendar className="h-3 w-3" />
                                                {new Date(result.timestamp).toLocaleDateString()}
                                            </span>
                                            <span className="flex items-center gap-1">
                                                <Clock className="h-3 w-3" />
                                                {new Date(result.timestamp).toLocaleTimeString()}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="text-right hidden sm:block">
                                        <div className="text-sm font-medium text-slate-300">
                                            {result.score} / {result.totalQuestions}
                                        </div>
                                        <div className="text-xs text-slate-500">Correct</div>
                                    </div>
                                    <Button variant="ghost" size="sm">
                                        View Details
                                    </Button>
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            )}
        </div>
    );
}
